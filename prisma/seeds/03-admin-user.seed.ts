import { PrismaClient } from '@prisma/client';
import * as bcryptjs from 'bcryptjs';

const prisma = new PrismaClient();

async function seedAdminUser() {
  console.log(
    "üë§ Cr√©ation de l'utilisateur administrateur et des utilisateurs de test...",
  );

  try {
    // 1. Cr√©er le minist√®re
    console.log('  üèõÔ∏è Cr√©ation du minist√®re...');
    const ministere = await prisma.ministere.create({
      data: {
        nom: "Minist√®re de l'√âducation",
        nomComplet:
          "Minist√®re de l'Enseignement Primaire, Secondaire et de l'Alphab√©tisation",
        code: 'MEPSA',
        acronyme: 'MEPSA',
        logoUrl: '/logos/ministere-education.png',
        siteWeb: 'https://www.mepsa.gouv.cg',
        email: 'contact@mepsa.gouv.cg',
        telephone: '+242 06 666 00 00',
        adresse: "Avenue de l'Ind√©pendance, Brazzaville",
        estActif: true,
      },
    });

    // 2. Cr√©er les d√©partements minist√©riels
    console.log('  üè¢ Cr√©ation des d√©partements minist√©riels...');
    const deptCabinet = await prisma.departementMinisteriel.create({
      data: {
        nom: 'Cabinet du Ministre',
        code: 'CAB',
        description: 'Cabinet du ministre et conseillers',
        ministereId: ministere.id,
        estActif: true,
      },
    });

    const deptSecGen = await prisma.departementMinisteriel.create({
      data: {
        nom: 'Secr√©tariat G√©n√©ral',
        code: 'SG',
        description: 'Secr√©tariat g√©n√©ral du minist√®re',
        ministereId: ministere.id,
        estActif: true,
      },
    });

    const deptRH = await prisma.departementMinisteriel.create({
      data: {
        nom: 'Direction des Ressources Humaines',
        code: 'DRH',
        description: 'Gestion des ressources humaines',
        ministereId: ministere.id,
        departementParentId: deptSecGen.id,
        estActif: true,
      },
    });

    const deptPlanif = await prisma.departementMinisteriel.create({
      data: {
        nom: 'Direction de la Planification',
        code: 'DPLAN',
        description: 'Planification et statistiques',
        ministereId: ministere.id,
        departementParentId: deptSecGen.id,
        estActif: true,
      },
    });

    const deptInspection = await prisma.departementMinisteriel.create({
      data: {
        nom: 'Inspection G√©n√©rale',
        code: 'IG',
        description: "Inspection g√©n√©rale de l'√©ducation",
        ministereId: ministere.id,
        estActif: true,
      },
    });

    // 3. R√©cup√©rer les groupes de s√©curit√©
    const superAdminGroup = await prisma.securityGroupMinistry.findFirst({
      where: { nom: 'Super Administrateurs' },
    });

    const directionCabinetGroup = await prisma.securityGroupMinistry.findFirst({
      where: { nom: 'Direction Cabinet' },
    });

    const inspecteursGroup = await prisma.securityGroupMinistry.findFirst({
      where: { nom: 'Inspecteurs G√©n√©raux' },
    });

    const directeursDeptGroup = await prisma.securityGroupMinistry.findFirst({
      where: { nom: 'Directeurs D√©partementaux' },
    });

    const analystesGroup = await prisma.securityGroupMinistry.findFirst({
      where: { nom: 'Analystes Statistiques' },
    });

    // 4. R√©cup√©rer un d√©partement g√©ographique (Brazzaville)
    const deptBrazzaville = await prisma.departement.findFirst({
      where: { code: 'BR' },
    });

    // 5. Hasher les mots de passe
    const defaultPasswordHash = await bcryptjs.hash('ChangeMe2024!', 12);

    // 6. Cr√©er le super administrateur
    console.log('  üë§ Cr√©ation du super administrateur...');
    const superAdmin = await prisma.userMinistry.create({
      data: {
        email: 'admin@mepsa.gouv.cg',
        passwordHash: defaultPasswordHash,
        prenom: 'Super',
        nom: 'Administrateur',
        typeUtilisateur: 'DIRECTEUR',
        titre: 'Administrateur Syst√®me',
        departementId: deptSecGen.id,
        estActif: true,
      },
    });

    // Assigner au groupe Super Admin
    await prisma.userMinistrySecurityGroup.create({
      data: {
        userId: superAdmin.id,
        groupId: superAdminGroup.id,
        estActif: true,
      },
    });

    // 7. Cr√©er le ministre
    console.log('  üë§ Cr√©ation du ministre...');
    const ministre = await prisma.userMinistry.create({
      data: {
        email: 'ministre@mepsa.gouv.cg',
        passwordHash: defaultPasswordHash,
        prenom: 'Jean-Luc',
        nom: 'MOUTHOU',
        typeUtilisateur: 'MINISTRE',
        titre: "Ministre de l'√âducation",
        departementId: deptCabinet.id,
        estActif: true,
      },
    });

    // Mettre √† jour le minist√®re avec le ministre actuel
    await prisma.ministere.update({
      where: { id: ministere.id },
      data: {
        ministreActuelId: ministre.id,
        dateNomination: new Date('2023-01-15'),
      },
    });

    // Assigner au groupe Direction Cabinet
    await prisma.userMinistrySecurityGroup.create({
      data: {
        userId: ministre.id,
        groupId: directionCabinetGroup.id,
        estActif: true,
      },
    });

    // 8. Cr√©er d'autres utilisateurs minist√®re
    console.log('  üë• Cr√©ation des utilisateurs minist√®re...');

    // Secr√©taire G√©n√©ral
    const secGen = await prisma.userMinistry.create({
      data: {
        email: 'sg@mepsa.gouv.cg',
        passwordHash: defaultPasswordHash,
        prenom: 'Marie',
        nom: 'BOUANGA',
        typeUtilisateur: 'SECRETAIRE_GENERAL',
        titre: 'Secr√©taire G√©n√©rale',
        departementId: deptSecGen.id,
        managerId: ministre.id,
        estActif: true,
      },
    });

    // Directeur RH
    const directeurRH = await prisma.userMinistry.create({
      data: {
        email: 'drh@mepsa.gouv.cg',
        passwordHash: defaultPasswordHash,
        prenom: 'Pierre',
        nom: 'NGOLO',
        typeUtilisateur: 'DIRECTEUR',
        titre: 'Directeur des Ressources Humaines',
        departementId: deptRH.id,
        managerId: secGen.id,
        estActif: true,
      },
    });

    // Inspecteur G√©n√©ral
    const inspecteurGeneral = await prisma.userMinistry.create({
      data: {
        email: 'ig@mepsa.gouv.cg',
        passwordHash: defaultPasswordHash,
        prenom: 'Alphonse',
        nom: 'MBEMBA',
        typeUtilisateur: 'INSPECTEUR',
        titre: 'Inspecteur G√©n√©ral',
        departementId: deptInspection.id,
        managerId: ministre.id,
        estActif: true,
      },
    });

    await prisma.userMinistrySecurityGroup.create({
      data: {
        userId: inspecteurGeneral.id,
        groupId: inspecteursGroup.id,
        estActif: true,
      },
    });

    // Directeur D√©partemental Brazzaville
    const directeurDeptBrazza = await prisma.userMinistry.create({
      data: {
        email: 'dd.brazza@mepsa.gouv.cg',
        passwordHash: defaultPasswordHash,
        prenom: 'Sylvain',
        nom: 'MAKAYA',
        typeUtilisateur: 'DIRECTEUR',
        titre: 'Directeur D√©partemental - Brazzaville',
        departementId: deptSecGen.id,
        departementGeoId: deptBrazzaville.id,
        managerId: secGen.id,
        estActif: true,
      },
    });

    await prisma.userMinistrySecurityGroup.create({
      data: {
        userId: directeurDeptBrazza.id,
        groupId: directeursDeptGroup.id,
        estActif: true,
      },
    });

    // Analyste Statistique
    const analyste = await prisma.userMinistry.create({
      data: {
        email: 'analyste@mepsa.gouv.cg',
        passwordHash: defaultPasswordHash,
        prenom: 'Clarisse',
        nom: 'MOUKOKO',
        typeUtilisateur: 'ANALYSTE',
        titre: 'Analyste Statistique Senior',
        departementId: deptPlanif.id,
        managerId: directeurRH.id,
        estActif: true,
      },
    });

    await prisma.userMinistrySecurityGroup.create({
      data: {
        userId: analyste.id,
        groupId: analystesGroup.id,
        estActif: true,
      },
    });

    // 9. Cr√©er un √©tablissement scolaire de test
    console.log("  üè´ Cr√©ation d'un √©tablissement de test...");

    const district = await prisma.district.findFirst({
      where: { code: 'BR-MK' }, // Mak√©l√©k√©l√©
    });

    const commune = await prisma.commune.findFirst({
      where: { districtId: district.id },
    });

    const arrondissement = await prisma.arrondissement.findFirst({
      where: { communeId: commune.id },
    });

    const lyceeTest = await prisma.etablissement.create({
      data: {
        nom: 'Lyc√©e de la R√©volution',
        codeEtablissement: 'LYC-REV-001',
        typeEtablissement: 'LYCEE_GENERAL',
        secteur: 'PUBLIC',
        statutAdministratif: 'AUTORISE',
        zone: 'URBAINE',
        adresseComplete: '123 Avenue de la Paix, Mak√©l√©k√©l√©',
        latitude: -4.2634,
        longitude: 15.2429,
        departementId: deptBrazzaville.id,
        districtId: district.id,
        communeId: commune.id,
        arrondissementId: arrondissement.id,
        numeroTelephone: '+242 06 666 11 11',
        emailOfficiel: 'lycee.revolution@education.cg',
        effectifTotalEleves: 800,
        effectifTotalPersonnel: 65,
        dateOuverture: new Date('1985-09-01'),
        estActif: true,
        creeParId: superAdmin.id,
        modifieParId: superAdmin.id,
      },
    });

    // 10. Cr√©er des utilisateurs √©cole
    console.log('  üè´ Cr√©ation des utilisateurs √©cole...');

    // R√©cup√©rer les groupes √©cole
    const directionEcoleGroup = await prisma.securityGroupSchool.findFirst({
      where: { nom: 'Direction √âcole' },
    });

    const enseignantsGroup = await prisma.securityGroupSchool.findFirst({
      where: { nom: 'Enseignants' },
    });

    const elevesGroup = await prisma.securityGroupSchool.findFirst({
      where: { nom: '√âl√®ves' },
    });

    const parentsGroup = await prisma.securityGroupSchool.findFirst({
      where: { nom: 'Parents' },
    });

    // Proviseur
    const proviseur = await prisma.userSchool.create({
      data: {
        email: 'proviseur.lyceerev@education.cg',
        passwordHash: defaultPasswordHash,
        prenom: 'Fran√ßois',
        nom: 'NKOUKA',
        typeUtilisateur: 'PROVISEUR',
        etablissementId: lyceeTest.id,
        matricule: 'DIR-001',
        estActif: true,
      },
    });

    await prisma.userSchoolSecurityGroup.create({
      data: {
        userId: proviseur.id,
        groupId: directionEcoleGroup.id,
        estActif: true,
      },
    });

    // Enseignant
    const enseignant = await prisma.userSchool.create({
      data: {
        email: 'prof.maths@lyceerev.education.cg',
        passwordHash: defaultPasswordHash,
        prenom: 'Jeanne',
        nom: 'MABIALA',
        typeUtilisateur: 'ENSEIGNANT',
        etablissementId: lyceeTest.id,
        matricule: 'ENS-042',
        matierePrincipale: 'Math√©matiques',
        estActif: true,
      },
    });

    await prisma.userSchoolSecurityGroup.create({
      data: {
        userId: enseignant.id,
        groupId: enseignantsGroup.id,
        estActif: true,
      },
    });

    // √âl√®ve
    const eleve = await prisma.userSchool.create({
      data: {
        email: 'eleve.test@lyceerev.education.cg',
        passwordHash: defaultPasswordHash,
        prenom: 'David',
        nom: 'MOUAYA',
        typeUtilisateur: 'ELEVE',
        etablissementId: lyceeTest.id,
        matricule: 'EL-2024-156',
        dateNaissance: new Date('2007-03-15'),
        classe: 'Terminale S1',
        estActif: true,
      },
    });

    await prisma.userSchoolSecurityGroup.create({
      data: {
        userId: eleve.id,
        groupId: elevesGroup.id,
        estActif: true,
      },
    });

    // Parent
    const parent = await prisma.userSchool.create({
      data: {
        email: 'parent.mouaya@gmail.com',
        passwordHash: defaultPasswordHash,
        prenom: 'Andr√©',
        nom: 'MOUAYA',
        typeUtilisateur: 'PARENT',
        etablissementId: lyceeTest.id,
        estActif: true,
      },
    });

    await prisma.userSchoolSecurityGroup.create({
      data: {
        userId: parent.id,
        groupId: parentsGroup.id,
        estActif: true,
      },
    });

    // Lier l'√©l√®ve au parent
    await prisma.userSchool.update({
      where: { id: eleve.id },
      data: { parentId: parent.id },
    });

    // Afficher le r√©sum√©
    const userMinistryCount = await prisma.userMinistry.count();
    const userSchoolCount = await prisma.userSchool.count();

    console.log('\nüìä R√©sum√© des utilisateurs cr√©√©s:');
    console.log(`  - Utilisateurs minist√®re: ${userMinistryCount}`);
    console.log(`  - Utilisateurs √©cole: ${userSchoolCount}`);
    console.log(`  - √âtablissements: 1`);

    console.log('\nüìß Comptes cr√©√©s:');
    console.log('  =====================================');
    console.log('  UTILISATEURS MINIST√àRE:');
    console.log('  -------------------------------------');
    console.log('  Super Admin:');
    console.log('    Email: admin@mepsa.gouv.cg');
    console.log('    Mot de passe: ChangeMe2024!');
    console.log('  -------------------------------------');
    console.log('  Ministre:');
    console.log('    Email: ministre@mepsa.gouv.cg');
    console.log('    Mot de passe: ChangeMe2024!');
    console.log('  -------------------------------------');
    console.log('  Secr√©taire G√©n√©ral:');
    console.log('    Email: sg@mepsa.gouv.cg');
    console.log('    Mot de passe: ChangeMe2024!');
    console.log('  -------------------------------------');
    console.log('  Inspecteur G√©n√©ral:');
    console.log('    Email: ig@mepsa.gouv.cg');
    console.log('    Mot de passe: ChangeMe2024!');
    console.log('  -------------------------------------');
    console.log('  Directeur D√©partemental Brazza:');
    console.log('    Email: dd.brazza@mepsa.gouv.cg');
    console.log('    Mot de passe: ChangeMe2024!');
    console.log('  -------------------------------------');
    console.log('  Analyste:');
    console.log('    Email: analyste@mepsa.gouv.cg');
    console.log('    Mot de passe: ChangeMe2024!');
    console.log('  =====================================');
    console.log('  UTILISATEURS √âCOLE:');
    console.log('  -------------------------------------');
    console.log('  Proviseur:');
    console.log('    Email: proviseur.lyceerev@education.cg');
    console.log('    Mot de passe: ChangeMe2024!');
    console.log('  -------------------------------------');
    console.log('  Enseignant:');
    console.log('    Email: prof.maths@lyceerev.education.cg');
    console.log('    Mot de passe: ChangeMe2024!');
    console.log('  -------------------------------------');
    console.log('  √âl√®ve:');
    console.log('    Email: eleve.test@lyceerev.education.cg');
    console.log('    Mot de passe: ChangeMe2024!');
    console.log('  -------------------------------------');
    console.log('  Parent:');
    console.log('    Email: parent.mouaya@gmail.com');
    console.log('    Mot de passe: ChangeMe2024!');
    console.log('  =====================================');

    console.log('\n‚úÖ Utilisateurs cr√©√©s avec succ√®s');
  } catch (error) {
    console.error('‚ùå Erreur lors de la cr√©ation des utilisateurs:', error);
    throw error;
  } finally {
    await prisma.$disconnect();
  }
}

// Ex√©cution
seedAdminUser().catch((e) => {
  console.error(e);
  process.exit(1);
});
